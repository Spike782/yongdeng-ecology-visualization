<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>永登生态可视化系统</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        :root{
            --primary:#0066cc;
            --primary-dark:#004c99;
            --primary-light:#e6f0ff;
            --white:#ffffff;
            --gray-bg:#f0f4f8;
            --border:#d0d9e5;
        }

        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-family: "Segoe UI", Arial, sans-serif;
            background: var(--gray-bg);
        }

        .controls {
            padding: 12px 18px;
            background: var(--white);
            box-shadow: 0 2px 6px rgba(0,102,204,.12);
            display: flex;               /* 保持横向弹性布局 */
            flex-wrap: wrap;             /* 允许内部换行 */
            gap: 12px;
            align-items: center;
            z-index: 100;
        }

        /* 各按钮组之间自动换行 */
        .row-main,
        .row-query,
        .row-basemap {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }

        .query-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .query-group span{
            font-size:14px;
            color:#004c99;
            font-weight:600;
        }
        select, button {
            padding: 8px 14px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            min-width: 88px;
            height: 36px;
            background: var(--white);
            color: var(--primary-dark);
            cursor: pointer;
            transition: all .2s;
            box-sizing: border-box;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        select:focus, button:focus{
            outline:none;
            border-color: var(--primary);
            box-shadow:0 0 0 2px var(--primary-light);
        }
        #showAllLandBtn,
        #showAllRiskBtn,
        .download-btn {
            font-weight: 600;
            border: none;
            height: 38px;
            min-width: 128px;
            border-radius: 8px;
        }
        #showAllLandBtn{
            background: var(--primary);
            color: var(--white);
        }
        #showAllLandBtn:hover{
            background: var(--primary-dark);
        }
        #showAllRiskBtn{
            background: #ff4757;
            color: var(--white);
        }
        #showAllRiskBtn:hover{
            background: #e03e4c;
        }
        .download-btn{
            background: #00b4d8;
            color: var(--white);
        }
        .download-btn:hover{
            background: #0096c7;
        }
        .basemap-btn {
            padding: 8px 12px;
            height: 36px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--white);
            cursor: pointer;
            font-size: 12px;
            color: var(--primary);
            transition: all .2s;
            min-width: 56px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .basemap-btn.active,
        .basemap-btn:hover{
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
        }

        #map-container {
            flex: 1;
            display: flex;
            position: relative;
        }
        #map {
            flex: 1;
            width: 100%;
            background: var(--gray-bg);
        }

        .message {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 8px 16px;
            border-radius: 6px;
            color: var(--white);
            display: none;
            z-index: 1000;
            font-size: 14px;
            box-shadow: 0 2px 6px rgba(0,0,0,.15);
        }
        .success { background: #00b894; }
        .error   { background: #ff4757; }


        .legend {
            position: fixed;
            bottom: 12px;
            right: 12px;
            background: var(--white);
            padding: 10px 14px;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0,102,204,.15);
            z-index: 1000;
            font-size: 12px;
        }
        .legend-title {
            font-weight: 700;
            margin-bottom: 6px;
            text-align: center;
            color: var(--primary-dark);
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 3px 0;
            color: #004c99;
        }
        .legend-color {
            width: 12px;
            height: 12px;
            margin-right: 6px;
            border: 1px solid #cfd8e3;
            border-radius: 2px;
        }

        /* 右侧图片查看器 */
        .image-viewer {
            width: 320px;
            background: var(--white);
            box-shadow: -2px 0 10px rgba(0,102,204,.1);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            z-index: 90;
            height: 100%;
        }
        .image-viewer.collapsed {
            transform: translateX(320px);
        }
        .image-viewer-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--primary-light);
        }
        .image-viewer-title {
            font-weight: 700;
            font-size: 16px;
            color: var(--primary-dark);
        }
        .image-viewer-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: var(--primary);
            padding: 2px 6px;
            transition: color .2s;
        }
        .image-viewer-close:hover {
            color: var(--primary-dark);
        }
        .image-viewer-content {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: var(--gray-bg);
        }
        .image-container {
            margin-bottom: 15px;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0,102,204,.12);
        }
        .viewer-image {
            width: 100%;
            height: auto;
            display: block;
        }
        .image-caption {
            padding: 8px 10px;
            background: var(--primary-light);
            font-size: 14px;
            text-align: center;
            color: var(--primary-dark);
            border-top: 1px solid var(--border);
        }

        .toggle-viewer {
            position: absolute;
            right: 320px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--white);
            border: none;
            width: 30px;
            height: 60px;
            box-shadow: -2px 0 5px rgba(0,102,204,.1);
            border-radius: 6px 0 0 6px;
            cursor: pointer;
            z-index: 80;
            transition: right 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .toggle-viewer.collapsed {
            right: 0;
        }
        .toggle-viewer i {
            color: var(--primary);
            transition: transform 0.3s ease;
        }
        .toggle-viewer.collapsed i {
            transform: rotate(180deg);
        }

        /* 响应式 */
        @media (max-width: 768px) {
            .image-viewer {
                width: 260px;
            }
            .toggle-viewer {
                right: 260px;
            }
        }
    </style>
</head>
<body>

<!-- 顶部导航栏（多行布局） -->
<div class="controls">
    <!-- 第 1 行：主功能 -->
    <div class="row-main">
        <button id="showAllLandBtn" onclick="showAllLandTypes()">显示全部土地类型</button>
        <button id="showAllRiskBtn" onclick="showAllRiskZones()">显示所有风险区</button>
        <button class="download-btn" onclick="downloadPDF('usage')">下载土地利用分类图</button>
        <button class="download-btn" onclick="downloadPDF('risk')">下载风险区分析图</button>
    </div>

    <!-- 第 2 行：查询类 -->
    <div class="row-query">
        <div class="query-group">
            <span>土地类型：</span>
            <select id="landType">
                <option value="">请选择</option>
                <option value="1">植被</option>
                <option value="2">水体</option>
                <option value="3">裸土</option>
                <option value="4">人工建筑</option>
            </select>
            <button onclick="queryByLandType()">查询土地类型</button>
        </div>

        <div class="query-group">
            <span>风险度：</span>
            <select id="riskLevel">
                <option value="">请选择</option>
                <option value="1">极低风险区</option>
                <option value="2">低风险区</option>
                <option value="3">中风险区</option>
                <option value="4">高风险区</option>
            </select>
            <button onclick="queryByRiskLevel()">查询风险度</button>
        </div>

        <div class="query-group">
            <span>综合查询：</span>
            <select id="customLandType">
                <option value="">土地类型</option>
                <option value="1">植被</option>
                <option value="2">水体</option>
                <option value="3">裸土</option>
                <option value="4">人工建筑</option>
            </select>
            <select id="customRiskLevel">
                <option value="">风险度</option>
                <option value="1">极低风险区</option>
                <option value="2">低风险区</option>
                <option value="3">中风险区</option>
                <option value="4">高风险区</option>
            </select>
            <button onclick="queryByCustom()">查询</button>
        </div>

        <button onclick="clearMap()">清除图层</button>
    </div>

    <!-- 第 3 行：底图切换 -->
    <div class="row-basemap">
        <span>底图：</span>
        <button class="basemap-btn active" onclick="setBasemap('amap-normal')">标准</button>
        <button class="basemap-btn" onclick="setBasemap('amap-satellite')">卫星</button>
        <button class="basemap-btn" onclick="setBasemap('none')">无</button>
    </div>
</div>

<!-- 地图容器 -->
<div id="map-container">
    <div id="map"></div>

    <!-- 右侧图片查看器 -->
    <div class="image-viewer" id="imageViewer">
        <div class="image-viewer-header">
            <div class="image-viewer-title">土地利用类型图</div>
            <button class="image-viewer-close" onclick="toggleImageViewer()">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        <div class="image-viewer-content">
            <div class="image-container">
                <img src="static/usage1.png" class="viewer-image" alt="土地利用图1" id="usageImage1" />
                <div class="image-caption">土地利用图1</div>
            </div>
            <div class="image-container">
                <img src="static/usage2.png" class="viewer-image" alt="土地利用图2" id="usageImage2" />
                <div class="image-caption">土地利用图2</div>
            </div>
        </div>
    </div>

    <button class="toggle-viewer" id="toggleViewer" onclick="toggleImageViewer()">
        <i class="fas fa-chevron-left"></i>
    </button>
</div>


<div id="message" class="message"></div>

<!-- 图例 -->
<div class="legend">
    <div class="legend-title">图例</div>
    <div class="legend-section">
        <div class="legend-item"><div class="legend-color" style="background:#4CAF50;"></div><span>植被</span></div>
        <div class="legend-item"><div class="legend-color" style="background:#2196F3;"></div><span>水体</span></div>
        <div class="legend-item"><div class="legend-color" style="background:#FFC107;"></div><span>裸土</span></div>
        <div class="legend-item"><div class="legend-color" style="background:#F44336;"></div><span>人工建筑</span></div>
    </div>
    <div class="legend-section" style="margin-top:8px;">
        <div class="legend-item"><div class="legend-color" style="background:#81C784;"></div><span>极低风险区</span></div>
        <div class="legend-item"><div class="legend-color" style="background:#4CAF50;"></div><span>低风险区</span></div>
        <div class="legend-item"><div class="legend-color" style="background:#FFB74D;"></div><span>中风险区</span></div>
        <div class="legend-item"><div class="legend-color" style="background:#F44336;"></div><span>高风险区</span></div>
    </div>
</div>


<script>
    const YONGDENG_BOUNDS = L.latLngBounds([36.1, 102.3], [37.3, 104.0]);
    const YONGDENG_CENTER = [36.78, 103.28];
    const YONGDENG_ZOOM = 10;
    const MAX_ZOOM = 14;
    const MIN_ZOOM = 9;

    const map = L.map('map', {
        renderer: L.canvas(),
        preferCanvas: true,
        zoomControl: true,
        attributionControl: false,
        maxBounds: YONGDENG_BOUNDS,
        maxBoundsViscosity: 0.9,
        minZoom: MIN_ZOOM,
        maxZoom: MAX_ZOOM
    }).setView(YONGDENG_CENTER, YONGDENG_ZOOM);

    let currentBasemap = null;
    const basemaps = {
        'amap-normal': L.tileLayer('https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
            subdomains: ['1', '2', '3', '4'],
            maxZoom: MAX_ZOOM,
            minZoom: MIN_ZOOM,
            bounds: YONGDENG_BOUNDS
        }),
        'amap-satellite': L.tileLayer('https://webst0{s}.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}', {
            subdomains: ['1', '2', '3', '4'],
            maxZoom: MAX_ZOOM,
            minZoom: MIN_ZOOM,
            bounds: YONGDENG_BOUNDS
        }),
        'none': null
    };
    setBasemap('amap-normal');

    let allLayers = [];
    let renderQueue = [];
    let isRendering = false;
    let boundaryLayer = null;
    let landUseLayers = [];
    let riskLevelLayers = [];

    const landTypeColors = { 1: '#4CAF50', 2: '#2196F3', 3: '#FFC107', 4: '#F44336' };
    const riskLevelColors = { 1: '#81C784', 2: '#4CAF50', 3: '#FFB74D', 4: '#F44336' };
    const comboGridcodeMap = [
        { risk: 3, usage: 3, value: 1 }, { risk: 3, usage: 1, value: 2 },
        { risk: 4, usage: 3, value: 3 }, { risk: 4, usage: 4, value: 4 },
        { risk: 3, usage: 4, value: 5 }, { risk: 4, usage: 1, value: 6 },
        { risk: 2, usage: 3, value: 7 }, { risk: 2, usage: 1, value: 8 },
        { risk: 3, usage: 2, value: 9 }, { risk: 4, usage: 2, value: 10 },
        { risk: 2, usage: 2, value: 11 }, { risk: 2, usage: 4, value: 12 },
        { risk: 1, usage: 3, value: 13 }, { risk: 1, usage: 1, value: 14 },
        { risk: 1, usage: 4, value: 15 }, { risk: 1, usage: 2, value: 16 }
    ];


    function showMessage(text, isError = false, duration = 3000) {
        const msg = document.getElementById('message');
        msg.textContent = text;
        msg.className = 'message ' + (isError ? 'error' : 'success');
        msg.style.display = 'block';
        setTimeout(() => msg.style.display = 'none', duration);
    }

    function downloadPDF(type) {
        if (!['usage', 'risk'].includes(type)) {
            showMessage('无效的下载类型', true);
            return;
        }
        showMessage(`正在准备${type === 'usage' ? '土地利用分类图' : '风险区分析图'}...`, false, 10000);
        const pdfUrl = `${type}.pdf`;
        const link = document.createElement('a');
        link.href = pdfUrl;
        link.download = `${type === 'usage' ? '土地利用分类图' : '风险区分析图'}.pdf`;
        fetch(pdfUrl, { method: 'HEAD' })
            .then(response => {
                if (!response.ok) throw new Error(`文件不存在或无法访问 (${response.status})`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showMessage(`${type === 'usage' ? '土地利用分类图' : '风险区分析图'}下载已开始`);

            })
            .catch(err => {
                showMessage(`下载失败: ${err.message}`, true);

            });
    }

    function toggleImageViewer() {
        const viewer = document.getElementById('imageViewer');
        const toggleBtn = document.getElementById('toggleViewer');
        viewer.classList.toggle('collapsed');
        toggleBtn.classList.toggle('collapsed');
        if (viewer.classList.contains('collapsed')) {
            showMessage('土地利用图已隐藏');

        } else {
            showMessage('土地利用图已显示');

        }
    }

    function setupImageErrorHandling() {
        ['usageImage1', 'usageImage2'].forEach(id => {
            const img = document.getElementById(id);
            img.addEventListener('error', () => {
                img.src = 'https://picsum.photos/300/200?grayscale';
                img.alt = `无法加载${img.alt}`;
                showMessage(`无法加载${img.alt}`, true);

            });
        });
    }

    function setBasemap(type) {
        if (currentBasemap && currentBasemap !== basemaps[type]) map.removeLayer(currentBasemap);
        if (type !== 'none' && basemaps[type]) {
            currentBasemap = basemaps[type];
            map.addLayer(currentBasemap);
        } else {
            currentBasemap = null;
            map.getContainer().style.backgroundColor = '#f5f5f5';
        }
        document.querySelectorAll('.basemap-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.basemap-btn[onclick="setBasemap('${type}')"]`).classList.add('active');

    }

    function clearMap() {
        [...allLayers, ...landUseLayers, ...riskLevelLayers].forEach(layer => map.removeLayer(layer));
        allLayers = []; landUseLayers = []; riskLevelLayers = [];
        renderQueue = []; isRendering = false;
        map.setView(YONGDENG_CENTER, YONGDENG_ZOOM);
        showMessage('已清除所有图层');

    }

    function loadBoundary() {
        fetch('yongdeng_boundary.json')
            .then(r => { if (!r.ok) throw new Error(`加载失败（状态码：${r.status}）`); return r.json(); })
            .then(geojson => {
                if (boundaryLayer) map.removeLayer(boundaryLayer);
                boundaryLayer = L.geoJSON(geojson, {
                    style: { color: '#004c99', weight: 3, fill: false, dashArray: '5, 5' }
                }).addTo(map);

            })
            .catch(err => {
            });
    }

    function parseWkt(wkt) {
        try {
            const trimWkt = wkt.trim();
            let type, coordinates;
            const cleanWkt = trimWkt.replace(/\s+/g, ' ').trim();

            if (cleanWkt.startsWith('MULTIPOLYGON')) {
                type = 'MultiPolygon';
                const startIndex = cleanWkt.indexOf('(((') + 3;
                const endIndex = cleanWkt.lastIndexOf(')))');
                if (startIndex === -1 || endIndex === -1 || startIndex >= endIndex)
                    throw new Error('MULTIPOLYGON格式不正确');
                const coordStr = cleanWkt.substring(startIndex, endIndex);
                coordinates = parseMultiPolygonCoordinates(coordStr);
            } else if (cleanWkt.startsWith('POLYGON')) {
                type = 'Polygon';
                const startIndex = cleanWkt.indexOf('((') + 2;
                const endIndex = cleanWkt.lastIndexOf('))');
                if (startIndex === -1 || endIndex === -1 || startIndex >= endIndex)
                    throw new Error('POLYGON格式不正确');
                const coordStr = cleanWkt.substring(startIndex, endIndex);
                coordinates = parsePolygonCoordinates(coordStr);
            } else {
                throw new Error(`不支持的类型: ${cleanWkt.substring(0, 10)}`);
            }
            return { type, coordinates };
        } catch (err) {
            return null;
        }
    }

    function parsePolygonCoordinates(coordStr) {
        const points = coordStr.split(',');
        if (points.length < 3) throw new Error(`多边形至少需要3个点，实际有${points.length}个`);
        return [points.map(point => {
            const coords = point.trim().split(/\s+/);
            if (coords.length !== 2) throw new Error(`无效坐标格式: ${point}`);
            const lng = parseFloat(coords[0]);
            const lat = parseFloat(coords[1]);
            if (isNaN(lng) || isNaN(lat)) throw new Error(`无效坐标值: ${point}`);
            return [lng, lat];
        })];
    }

    function parseMultiPolygonCoordinates(coordStr) {
        return [parsePolygonCoordinates(coordStr)];
    }

    function startRenderQueue() {
        if (isRendering || !renderQueue.length) return;
        isRendering = true;

        let totalValid = 0;
        let totalEmptyGeom = 0;
        let totalParseError = 0;
        const allBounds = L.latLngBounds();


        const processBatch = () => {
            const batch = renderQueue.splice(0, 200);
            if (!batch.length) {
                isRendering = false;
                showMessage(`渲染完成：共${totalValid}条数据`);
                if (totalValid > 0 && !allBounds.isEmpty()) {
                    map.fitBounds(allBounds, { padding: [50, 50], maxZoom: MAX_ZOOM });
                }
                return;
            }

            batch.forEach(item => {
                if (!item.Geom || item.Geom.trim() === '') {
                    totalEmptyGeom++;
                    return;
                }

                const geometry = parseWkt(item.Geom);
                if (!geometry) {
                    totalParseError++;
                    return;
                }

                try {
                    const geojson = { type: "Feature", geometry: geometry, properties: {} };
                    let style = { color: '#333', weight: 1, fillOpacity: 0.7 };

                    if (item.type === 'usage') {
                        style.fillColor = landTypeColors[item.gridcode] || '#999';
                    } else if (item.type === 'risk') {
                        style.fillColor = riskLevelColors[item.gridcode] || '#999';
                    } else if (item.type === 'combo') {
                        style.fillColor = riskLevelColors[item.risk] || '#999';
                    }

                    const layer = L.geoJSON(geojson, { style }).addTo(map);
                    allLayers.push(layer);

                    if (item.type === 'usage') {
                        landUseLayers.push(layer);
                    } else if (item.type === 'risk') {
                        riskLevelLayers.push(layer);
                    }

                    totalValid++;
                    allBounds.extend(layer.getBounds());
                } catch (err) {
                    totalParseError++;
                }
            });

            requestAnimationFrame(processBatch);
        };

        processBatch();
    }

    async function queryByLandType() {
        clearMap();
        const landType = document.getElementById('landType').value;
        if (!landType) return showMessage('请选择土地类型', true);
        try {
            const res = await fetch(`http://localhost:8080/api/usages/gridcode?gridcode=${landType}&page=1&pageSize=1000`);
            const result = await res.json();
            if (!result.data || !Array.isArray(result.data)) throw new Error('数据格式错误');
            renderQueue = result.data.map(item => ({ ...item, type: 'usage', gridcode: landType }));
            startRenderQueue();
        } catch (err) {
            showMessage(err.message, true);
        }
    }

    async function queryByRiskLevel() {
        clearMap();
        const riskLevel = document.getElementById('riskLevel').value;
        if (!riskLevel) return showMessage('请选择风险度', true);
        try {
            const res = await fetch(`http://localhost:8080/api/risks/gridcode?gridcode=${riskLevel}&page=1&pageSize=1000`);
            const result = await res.json();
            if (!result.data || !Array.isArray(result.data)) throw new Error('数据格式错误');
            renderQueue = result.data.map(item => ({ ...item, type: 'risk', gridcode: riskLevel }));
            startRenderQueue();
        } catch (err) {
            showMessage(err.message, true);
        }
    }

    async function queryByCustom() {
        clearMap();
        const landType = document.getElementById('customLandType').value;
        const riskLevel = document.getElementById('customRiskLevel').value;
        if (!landType || !riskLevel) return showMessage('请同时选择土地类型和风险度', true);
        const risk = parseInt(riskLevel);
        const usage = parseInt(landType);
        const comboItem = comboGridcodeMap.find(item => item.risk === risk && item.usage === usage);
        if (!comboItem) return showMessage('未找到对应的组合数据', true);
        try {
            const res = await fetch(`http://localhost:8080/api/riskusage/gridcode?gridcode=${comboItem.value}&page=1&pageSize=1000`);
            const result = await res.json();
            if (!result.data || !Array.isArray(result.data)) throw new Error('数据格式错误');
            renderQueue = result.data.map(item => ({ ...item, type: 'combo', gridcode: comboItem.value, risk, usage }));
            startRenderQueue();
        } catch (err) {
            showMessage(err.message, true);
        }
    }

    async function showAllLandTypes() {
        clearMap();
        showMessage('正在加载全部土地类型...', false, 10000);
        try {
            const res = await fetch('http://localhost:8080/api/usages/gridcode?gridcode=all&page=1&pageSize=5000');
            // 移除日志打印
            const result = await res.json();
            if (!result.data || !Array.isArray(result.data)) {
                const landTypes = ['1', '2', '3', '4'];
                const promises = landTypes.map(type =>
                    fetch(`http://localhost:8080/api/usages/gridcode?gridcode=${type}&page=1&pageSize=1000`)
                        .then(r => r.json())
                        .then(data => data.data || [])
                        .then(items => items.map(item => ({ ...item, type: 'usage', gridcode: type })))
                );
                const allData = await Promise.all(promises);
                renderQueue = [].concat(...allData);
            } else {
                renderQueue = result.data.map(item => ({
                    ...item,
                    type: 'usage',
                    gridcode: item.gridcode || item.landType
                }));
            }
            startRenderQueue();
        } catch (err) {
            showMessage(`加载失败: ${err.message}`, true);
        }
    }

    async function showAllRiskZones() {
        clearMap();
        showMessage('正在加载所有风险区...', false, 10000);
        try {
            const res = await fetch('http://localhost:8080/api/risks/gridcode?gridcode=all&page=1&pageSize=5000');
            const result = await res.json();
            if (!result.data || !Array.isArray(result.data)) {
                const riskLevels = ['1', '2', '3', '4'];
                const promises = riskLevels.map(level =>
                    fetch(`http://localhost:8080/api/risks/gridcode?gridcode=${level}&page=1&pageSize=1000`)
                        .then(r => r.json())
                        .then(data => data.data || [])
                        .then(items => items.map(item => ({ ...item, type: 'risk', gridcode: level })))
                );
                const allData = await Promise.all(promises);
                renderQueue = [].concat(...allData);
            } else {
                renderQueue = result.data.map(item => ({
                    ...item,
                    type: 'risk',
                    gridcode: item.gridcode || item.riskLevel
                }));
            }
            startRenderQueue();
        } catch (err) {
            showMessage(`加载失败: ${err.message}`, true);
        }
    }

    // 页面初始化
    window.onload = () => {
        loadBoundary();
        setupImageErrorHandling();
        showMessage('地图准备就绪', false, 2000);
    };
</script>
</body>
</html>